name: Deploy Marzban Dashboard

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Copy install script via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: "install.sh"
          target: "/tmp/"

      - name: Execute Install Script
        uses: appleboy/ssh-action@v1.0.3
        env:
          DOMAIN: ${{ secrets.DOMAIN_NAME }}
          DASH_PORT: "6104"       
          INTERVAL: "10"          
          DASH_USER: "admin"      
          DASH_PASS: ${{ secrets.ADMIN_PASS }}
          INSTALL_VPN: "n"        # <--- Set to 'n' to skip VPN install
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          # Only mapping the variables we actually use now
          envs: DOMAIN,DASH_PORT,INTERVAL,DASH_USER,DASH_PASS,INSTALL_VPN
          script: |
            chmod +x /tmp/install.sh
            
            # Pipe inputs. Since INSTALL_VPN is 'n', the script will exit 
            # without asking for VPN credentials.
            # Order: Domain -> Port -> Interval -> User -> Pass -> InstallVPN(n)
            printf "%s\n%s\n%s\n%s\n%s\n%s\n" \
              "$DOMAIN" \
              "$DASH_PORT" \
              "$INTERVAL" \
              "$DASH_USER" \
              "$DASH_PASS" \
              "$INSTALL_VPN" | sudo /tmp/install.sh
